<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Command Center | EV Fleet AI</title>

  <link rel="stylesheet" href="../css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../js/sidebar.js" defer></script>

  <style>
    :root {
      --bg-dark: #0f172a;
      --card-bg: #1e293b;
      --accent-blue: #3b82f6;
      --accent-green: #10b981;
      --accent-eco: #059669; /* Specific Green for CO2 */
      --accent-red: #ef4444;
      --text-main: #f1f5f9;
      --text-dim: #94a3b8;
    }

    /* Layout & Grids */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    /* Professional Card Styling */
    .card {
      background: var(--card-bg);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s ease;
    }

    .metric-card {
      border-left: 5px solid var(--accent-blue);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Sustainability Glow Effect */
    .eco-card {
      border-left: 5px solid var(--accent-eco);
      background: linear-gradient(145deg, #1e293b, #131c2b);
    }

    .metric-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      display: block;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--text-main);
      margin: 0;
    }

    .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
    .chart-wrapper, .alerts-panel {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .alerts-list { list-style: none; padding: 0; margin-top: 15px; max-height: 320px; overflow-y: auto; }
    .alert-item {
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.03);
      border-left: 4px solid #f59e0b;
      font-size: 0.85rem;
    }
    .alert-critical { border-left-color: var(--accent-red); background: rgba(239, 68, 68, 0.08); }

    .pulse {
      display: inline-block; width: 8px; height: 8px; border-radius: 50%;
      background: var(--accent-green); margin-right: 8px;
      animation: pulse-animation 2s infinite;
    }

    @keyframes pulse-animation {
      0% { box-shadow: 0 0 0 0px rgba(16, 185, 129, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
      100% { box-shadow: 0 0 0 0px rgba(16, 185, 129, 0); }
    }
  </style>
</head>

<body class="app">
  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-header"><h2 class="logo">EV FLEET <span style="color:var(--accent-blue)">AI</span></h2></div>
      <nav class="sidebar-nav">
        <a href="index.html" class="nav-link active">Dashboard</a>
        <a href="logs.html" class="nav-link">Fleet Logs</a>
        <a href="route.html" class="nav-link">Route Monitor</a>
        <a href="prediction.html" class="nav-link">Predictions</a>
      </nav>
    </aside>

    <div class="app-main">
      <header class="topbar">
        <div class="topbar-left">
          <h1 class="page-title">Fleet Command Center</h1>
          <p class="page-subtitle"><span class="pulse"></span> Live Telemetry: <span id="syncTime">--:--:--</span></p>
        </div>
      </header>

      <main class="content">
        <section class="kpi-grid">
          <article class="card metric-card" style="border-left-color: var(--accent-green);">
            <span class="metric-label">Operational Readiness</span>
            <p id="fleetReadiness" class="metric-value">--%</p>
          </article>
          <article class="card metric-card">
            <span class="metric-label">Avg. SoC</span>
            <p id="avgSoc" class="metric-value">--%</p>
          </article>
          <article class="card metric-card" style="border-left-color: #6366f1;">
            <span class="metric-label">Battery Health</span>
            <p id="avgSoh" class="metric-value">--%</p>
          </article>
          <article class="card metric-card" style="border-left-color: #f59e0b;">
            <span class="metric-label">Energy Load</span>
            <p id="energy" class="metric-value">-- kWh</p>
          </article>
          <article class="card metric-card eco-card">
            <span class="metric-label">ðŸŒ± CO2 Saved</span>
            <p id="co2Savings" class="metric-value" style="color: var(--accent-green);">-- kg</p>
          </article>
        </section>

        <div class="main-grid">
          <div class="chart-wrapper">
            <h3 class="metric-label">Energy Demand Trend (24h)</h3>
            <div style="height: 300px; margin-top: 20px;">
              <canvas id="energyChart"></canvas>
            </div>
          </div>

          <div class="status-container" style="display: flex; flex-direction: column; gap: 20px;">
            <div class="alerts-panel">
              <h3 class="metric-label">Vehicle Distribution</h3>
              <div style="height: 150px; margin-bottom: 10px;">
                <canvas id="statusChart"></canvas>
              </div>
            </div>

            <div class="alerts-panel">
              <h3 class="metric-label">System Alerts</h3>
              <div id="alertsState" style="color: var(--text-dim); font-size: 0.75rem; margin-top: 10px;">Checking systems...</div>
              <ul id="alerts" class="alerts-list"></ul>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:5000";
    let energyChart = null;
    let statusChart = null;

    document.addEventListener("DOMContentLoaded", () => {
      fetchDashboardMetrics();
      setInterval(fetchDashboardMetrics, 10000); 
    });

    async function fetchDashboardMetrics() {
      try {
        const res = await fetch(`${API_BASE}/api/dashboard/kpis`);
        const json = await res.json();
        if (!res.ok || !json.success) return;

        const m = json.data || {};
        
        // Time Sync
        document.getElementById("syncTime").textContent = new Date().toLocaleTimeString();

        // Update Dashboard Text
        document.getElementById("fleetReadiness").textContent = `${m.fleet_readiness || 0}%`;
        document.getElementById("avgSoc").textContent = `${m.avg_soc || 0}%`;
        document.getElementById("avgSoh").textContent = `${m.avg_soh || 0}%`;
        document.getElementById("energy").textContent = `${m.total_energy || 0} kWh`;
        
        // Sustainability Logic
        document.getElementById("co2Savings").textContent = `${m.co2_savings || 0} kg`;

        renderAlerts(m.alerts);
        renderCharts(m.energy_history, m.status_counts);

      } catch (err) { console.error("Sync Error:", err); }
    }

    function renderAlerts(alerts = []) {
      const list = document.getElementById("alerts");
      const state = document.getElementById("alertsState");
      list.innerHTML = "";
      
      if (!alerts || alerts.length === 0) {
        state.style.display = "block";
        state.innerHTML = "<span style='color:var(--accent-green)'>âœ” Fleet Healthy</span>";
        return;
      }
      state.style.display = "none";
      alerts.forEach(a => {
        const li = document.createElement("li");
        const isCritical = a.level === "critical";
        li.className = `alert-item ${isCritical ? 'alert-critical' : ''}`;
        li.innerHTML = `<strong>${a.bus_id}</strong>: ${a.issue}`;
        list.appendChild(li);
      });
    }

    function renderCharts(history, counts) {
      const eCtx = document.getElementById("energyChart").getContext("2d");
      const sCtx = document.getElementById("statusChart").getContext("2d");

      // Energy Line Chart
      if (energyChart) {
        energyChart.data.labels = history.map(h => h.timestamp);
        energyChart.data.datasets[0].data = history.map(h => h.value);
        energyChart.update();
      } else {
        energyChart = new Chart(eCtx, {
          type: "line",
          data: {
            labels: history.map(h => h.timestamp),
            datasets: [{
              data: history.map(h => h.value),
              borderColor: "#3b82f6", backgroundColor: "rgba(59, 130, 246, 0.1)",
              fill: true, tension: 0.4, borderWidth: 3, pointRadius: 2
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }

      // Status Doughnut
      const sData = [counts.active || 0, counts.idle || 0, counts.critical || 0];
      if (statusChart) {
        statusChart.data.datasets[0].data = sData;
        statusChart.update();
      } else {
        statusChart = new Chart(sCtx, {
          type: "doughnut",
          data: {
            labels: ["Active", "Idle", "Warning"],
            datasets: [{ data: sData, backgroundColor: ["#10b981", "#64748b", "#ef4444"], borderWidth: 0 }]
          },
          options: { responsive: true, maintainAspectRatio: false, cutout: "70%", plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } } }
        });
      }
    }
  </script>
</body>
</html>